{{- $pw := env.Getenv "PW" -}}
version: "3"
services:
  configs:
    image: quay.io/coreos/butane:release
    entrypoint: ""
    container_name: configs
    restart: "no"
    volumes:
      - type: volume
        source: inadyn
        target: /inadyn
        volume:
          nocopy: true
      - type: volume
        source: ignition
        target: /ignition
        volume:
          nocopy: true
    environment:
      INADYN: |
        period     = 300
        user-agent = Mozilla/5.0
        provider cloudflare.com {
            username = zhaohai.li
            password = {{ base64.Decode "x5UNS3mLUV/M2QFJEUAQ4vedFT19mqHCOsUaTrmpY+CTl3/IM9gWeqGvavwT3o4X6xlv9NhsJWvIySopuUvrig==" | crypto.DecryptAES $pw 256 }}
            hostname = "*.zhaohai.li"
            ttl = 1 # optional, value of 1 is 'automatic'.
            proxied = true # optional.
        }

      IGNTION: |
        variant: "fcos"
        version: "1.4.0"
        passwd:
          users:
            - name: "googol"
              groups:
                - "sudo"
                - "docker"
                - "adm"
                - "systemd-journal"
              password_hash: "{{ `$y$j9T$bUxnG.hS5Y43W5SzQpFcL1$WnZ1OTvv0rs1Z6URFxPvF9vnK2D5VbgG8HDLep.gLC4` | strings.ReplaceAll `$` `$$` }}"
              ssh_authorized_keys: 
                - |
                  {{ base64.Decode "jFz/kQqf3XbmIBYtY4VyxnkZ8X6QLwyg+hJvwPV+VoJ/OoPxmjjhaZQDOeZ1NMgwkWwvVcCjVS8B2Zgb78RcNP5Z3LA2pbkdQGLQDFFpfInwK9/r11mDvBXhDohjNEFomViFYJh28o/ZP/Ep9t3YLxeRU1RkALic/1iO1xWvAqmn3CVoQdoHgsY+GNzAi3Vp+d10PebqR7Mg5wobBwVjbfmtTyI4mzZwAKEWoGFzbjzdiN8gCHT3ngZ0pvXrlvZOijfkKC2bgXR69NyjkesJhd47AaK8jg+XBb3UxKfdCZcxPx+olVBYAEasFXl2AAr7NsY4wAXaG281Z/fKlNzlf2crdwX/9FFPKQWiAJEvKOKPPP/nKrz7JB5WRITEukOhMFWQvCXIrQ82iayrbBGjXzxw94d6jL8yELiMWik5aRvM6/PoUaFsBn25eslSw2iT1chwehV82ev5rCrB8+P5UkJcgzSMq6AlINOeuSSNMcIf18RbfzOcDMvkwDv7JXgH0SsXKM9X17tQtlBBrsN3F7DCtdWBkYX+SbMTXs9++1FgliXbN1pCQpqdzhNR5TBKWetb8KB8kLGjJ2wo3pCXVX5Tm2Oub/1tawQcC6NfB3MhxYpu7lexX1AQmI0DWgcxtGVGh4P/cQTarB3ycUgoAm5Hxlsx/g7AsDZU2DscfAgudk3enw4vQSyuIbnwpMezC6ORp5fquicwoQOfEjk6NaElXhvWmT+dO9KV90aVox1HxuHDoSnOedM+SVkunjjXza/pXJ/nIzq+DCDbrYgb9HQdXvSpKIPw/jEHZeN32UogMP5IdTiPicJo3RBAe7qZeXgI85eGOiQ9R9FWpn4xq4sihm6hbcZtwrSz1tkBWmdGGEJDOf07jAZF6I217HQ+CObnhcYpXoZvZUuw4YUNrmfyPoch5sE8+mAMj34huApazD67gTv8S1bnv1QAKCkFYnrLgoAMFHvWqDze81A0QnyJSpLjXOUrMWGCj6WazRpJ65BvhUyV6KbSxiXT8Spi" | crypto.DecryptAES $pw 256 }}
        systemd:
          units:
            - name: "var-mnt-multimedia.mount"
              enabled: true
              contents: |
                [Unit]
                Description=Mount data directory

                [Mount]
                What=//nas.local/Multimedia
                Where=/var/mnt/multimedia/
                Type=cifs
                Options=rw,username=googol,password={{ base64.Decode "aEOpNFNd44182ENhkUYMilZsODXaDqTJ9kyD86jz0Qo=" | crypto.DecryptAES $pw 256 }}

                [Install]
                WantedBy=multi-user.target
        storage:
          files:
            - path: "/etc/hostname"
              mode: 0644
              user:
                name: "root"
              group:
                name: "root"
              contents:
                inline: |
                  coreos
            - path: /etc/NetworkManager/system-connections/ens3.nmconnection
              mode: 0600
              contents:
                inline: |
                  [connection]
                  id=ens3
                  type=ethernet
                  interface-name=ens3
                  [ipv4]
                  address1=192.168.10.3/24,192.168.10.1
                  dns=192.168.10.2;192.168.10.1;
                  dns-search=local;
                  may-fail=false
                  method=manual
            - path: /etc/zincati/config.d/55-updates-strategy.toml
              contents:
                inline: |
                  [updates]
                  strategy = "periodic"
                  [[updates.periodic.window]]
                  days = [ "Mon", "Tue" ]
                  start_time = "02:30"
                  length_minutes = 60
          links:
            - path: /etc/localtime
              target: ../usr/share/zoneinfo/Europe/Berlin
          directories:
            - path: "/var/mnt/multimedia"
              mode: 0755
              user:
                name: "root"
              group:
                name: "root"
    command:
      - "/bin/bash"
      - "-c"
      - |
        echo "$${INADYN}" > /inadyn/inadyn.conf
        echo "$${IGNTION}" | butane -ps > /ignition/coreos.json

  nginx:
    image: nginx:stable
    container_name: nginx
    depends_on:
      configs:
        condition: service_completed_successfully
    ports:
      - 2048:80
    volumes:
      - type: volume
        source: ignition
        target: /usr/share/nginx/html
        volume:
          nocopy: true

  inadyn:
    image: alpine:3.17
    container_name: inadyn
    depends_on:
      configs:
        condition: service_completed_successfully
    volumes:
      - type: volume
        source: inadyn
        target: /config
        volume:
          nocopy: true
    command:
      - "/bin/sh"
      - "-c"
      - |
        apk add inadyn
        exec inadyn --foreground --no-pidfile -f /config/inadyn.conf

  dnsmasq:
    image: alpine:3.17
    container_name: dnsmasq
    ports:
      - 192.168.10.2:53:53/tcp
      - 192.168.10.2:53:53/udp
    command:
      - "/bin/sh"
      - "-c"
      - |
        apk add dnsmasq
        exec dnsmasq --enable-ra --no-hosts --no-daemon -k \
          --except-interface=lo \
          --local=/zhaohai.li/ \
          --domain=zhaohai.li \
          --address=/zhaohai.li/192.160.10.3 \
          --address=/coreos.local/192.160.10.3 \
          --address=/nasl.local/192.160.10.2 \
          --address=/router.local/192.160.10.1

volumes:
  inadyn:
    name: "inadyn"
  ignition:
    name: "ignition"
